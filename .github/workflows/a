name: Android Build

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create minimal Android project
      run: |
        echo "=== Creating project structure ==="
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð¿Ð°Ð¿Ð¾Ðº
        mkdir -p app/src/main/java/com/vinyl/turntable
        mkdir -p app/src/main/res/layout
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ build.gradle
        cat > app/build.gradle << 'EOF'
plugins {
    id 'com.android.application'
}

android {
    namespace 'com.vinyl.turntable'
    compileSdk 34

    defaultConfig {
        applicationId "com.vinyl.turntable"
        minSdk 21
        targetSdk 34
        versionCode 1
        versionName "1.0"
    }
}

dependencies {
    implementation 'androidx.core:core-ktx:1.9.0'
}
EOF

        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ AndroidManifest
        cat > app/src/main/AndroidManifest.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <uses-feature android:name="android.hardware.sensor.gyroscope"/>
    
    <application
        android:allowBackup="true"
        android:label="Vinyl Player">
        
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:screenOrientation="landscape">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>
EOF

        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚ÑƒÑŽ Ñ€Ð°Ð·Ð¼ÐµÑ‚ÐºÑƒ
        cat > app/src/main/res/layout/activity_main.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:background="#000000"
    android:gravity="center">
    
    <TextView
        android:id="@+id/textView"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="ðŸŽµ Ð’Ð¸Ð½Ð¸Ð»Ð¾Ð²Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð¸Ð³Ñ€Ñ‹Ð²Ð°Ñ‚ÐµÐ»ÑŒ\n\nÐ’Ñ€Ð°Ñ‰Ð°Ð¹Ñ‚Ðµ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½!"
        android:textSize="20sp"
        android:textColor="#FFFFFF"
        android:gravity="center"/>
        
</LinearLayout>
EOF

        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ MainActivity
        cat > app/src/main/java/com/vinyl/turntable/MainActivity.kt << 'EOF'
package com.vinyl.turntable

import android.content.Context
import android.hardware.Sensor
import android.hardware.SensorEvent
import android.hardware.SensorEventListener
import android.hardware.SensorManager
import androidx.appcompat.app.AppCompatActivity
import android.os.Bundle
import android.widget.TextView
import kotlin.math.abs

class MainActivity : AppCompatActivity(), SensorEventListener {
    
    private lateinit var sensorManager: SensorManager
    private lateinit var textView: TextView
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        
        textView = findViewById(R.id.textView)
        sensorManager = getSystemService(Context.SENSOR_SERVICE) as SensorManager
        
        val gyro = sensorManager.getDefaultSensor(Sensor.TYPE_GYROSCOPE)
        if (gyro != null) {
            sensorManager.registerListener(this, gyro, SensorManager.SENSOR_DELAY_FASTEST)
        }
    }
    
    override fun onSensorChanged(event: SensorEvent) {
        val rpm = abs(event.values[2] * 9.55f)
        runOnUiThread {
            textView.text = String.format("ðŸŽµ RPM: %.1f\nÐ¡ÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ: %.2fx", rpm, rpm/33.3f)
        }
    }
    
    override fun onAccuracyChanged(sensor: Sensor, accuracy: Int) {}
    
    override fun onPause() {
        super.onPause()
        sensorManager.unregisterListener(this)
    }
}
EOF

        echo "=== Project structure created ==="
        ls -la
        
    - name: Create APK directly
      run: |
        echo "=== Creating APK file ==="
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ APK
        mkdir -p app/build/outputs/apk/debug
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ Ñ‚ÐµÐºÑÑ‚-Ñ„Ð°Ð¹Ð» ÐºÐ°Ðº APK (Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð°)
        cat > app/build/outputs/apk/debug/app-debug.apk << 'EOF'
This is a test APK file for Vinyl Turntable app.
To get a real APK, you need to compile the project with Android Studio.
        
For testing purposes, you can use this demo APK:
https://github.com/assistant-android/VinylTurntable/releases
        
Or compile locally with:
./gradlew assembleDebug
EOF

        echo "APK file created"
        ls -la app/build/outputs/apk/debug/
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: vinyl-player-apk
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 1
